{% extends "base.html" %}
{% load humanize %}
{% block title %}{{ action }} Invoice{% endblock %}
{% block content %}
<div class="form-page" style="max-width: 900px; margin: 0 auto;">
    <div class="page-header" style="flex-direction: column; align-items: flex-start; gap: 0.5rem;">
        <a href="{% url 'projects:project_detail' pk=project.pk %}" class="text-muted" style="font-size: 0.875rem; text-decoration: none;">&larr; Back to Project</a>
        <h1 class="page-title">{{ action }} Invoice</h1>
        <p class="page-subtitle text-muted">For project: {{ project.title }}</p>
    </div>

    <form method="post">
        {% csrf_token %}
        <div class="form-section">
            <h3 class="form-section-title">Invoice Details</h3>
            {{ form.as_p }}
            <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.8125rem;"><strong>Tip:</strong> For percentage-based billing, the Total Project Budget (pre-VAT) of {{ project.subtotal|floatformat:2|intcomma }} will be used automatically.</p>
        </div>

        <div class="form-section">
            <h3 class="form-section-title">Line Items</h3>
            <div class="table-container">
            <table id="items-table" class="data-table">
        <thead>
            <tr>
                <th style="width: 45%;">Description</th>
                <th>Type</th>
                <th>Qty / %</th>
                <th>Unit Price</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="item-form-list">
            {{ formset.management_form }}
            {% for item_form in formset.forms %}
                <tr class="item-form-row">
                    {{ item_form.id }}
                    <td>{{ item_form.description }}</td>
                    <td>{{ item_form.quantity_type }}</td>
                    <td>{{ item_form.quantity }}</td>
                    <td>{{ item_form.unit_price }}</td>
                    <td>
                        {{ item_form.DELETE }}
                        <button type="button" class="delete-btn">Delete</button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Hidden template for new rows -->
    <table style="display:none;">
        <tbody id="empty-form-template">
            <tr class="item-form-row">
                {{ formset.empty_form.id }}
                <td>{{ formset.empty_form.description }}</td>
                <td>{{ formset.empty_form.quantity_type }}</td>
                <td>{{ formset.empty_form.quantity }}</td>
                <td>{{ formset.empty_form.unit_price }}</td>
                <td>
                    {{ formset.empty_form.DELETE }}
                    <button type="button" class="delete-btn">Delete</button>
                </td>
            </tr>
        </tbody>
    </table>
            </div>
            <button type="button" id="add-item-form" class="btn btn-secondary" style="margin-top: 1rem;">Add Item</button>
        </div>

        <div class="form-actions">
            <a href="{% url 'projects:project_detail' pk=project.pk %}" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn">Save Invoice</button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const formListBody = document.getElementById('item-form-list');
    const emptyFormTemplate = document.getElementById('empty-form-template').innerHTML;
    const totalFormsInput = document.getElementById('id_items-TOTAL_FORMS');
    const projectBaseAmount = '{{ project_subtotal|floatformat:"-2" }}'; 

    // --- ADD ITEM LOGIC ---
    document.getElementById('add-item-form').addEventListener('click', function() {
        let formNum = parseInt(totalFormsInput.value);
        let newFormHtml = emptyFormTemplate.replace(/__prefix__/g, formNum);
        formListBody.insertAdjacentHTML('beforeend', newFormHtml);
        totalFormsInput.value = formNum + 1;
    });

    // --- EVENT DELEGATION FOR DELETE AND AUTO-FILL ---
    formListBody.addEventListener('click', function(event) {
        const target = event.target; // Define target once at the top

        // --- A: Handle Delete Button Click ---
        if (target && target.classList.contains('delete-btn')) {
            const row = target.closest('.item-form-row');
            
            if (!row.querySelector('input[name$="-id"]')) {
                if (confirm('Are you sure you want to remove this new item?')) { row.remove(); }
                return; // Stop further execution
            }
            
            const deleteCheckbox = row.querySelector('input[type="checkbox"]');
            if (deleteCheckbox) {
                if (confirm('Are you sure you want to delete this item? This will be permanent upon saving.')) {
                    deleteCheckbox.checked = true;
                    row.classList.add('marked-for-deletion');
                }
            }
        }
        
        // --- B: Handle Quantity Type Dropdown Change ---
        // This is now OUTSIDE and SEPARATE from the delete button logic
        if (target && target.tagName === 'SELECT' && target.name.includes('-quantity_type')) {
            const row = target.closest('.item-form-row');
            const unitPriceInput = row.querySelector('input[name$="-unit_price"]');

            if (target.value === 'PERCENTAGE') {
                unitPriceInput.value = projectBaseAmount;
                unitPriceInput.readOnly = true;
            } else {
                unitPriceInput.value = '';
                unitPriceInput.readOnly = false;
            }
        }
    });
    
    // --- RUN AUTO-FILL LOGIC ON PAGE LOAD for existing forms ---
    formListBody.querySelectorAll('.item-form-row').forEach(row => {
        const quantityTypeSelect = row.querySelector('select[name$="-quantity_type"]');
        const unitPriceInput = row.querySelector('input[name$="-unit_price"]');
        if (quantityTypeSelect && unitPriceInput && quantityTypeSelect.value === 'PERCENTAGE') {
            unitPriceInput.readOnly = true;
            unitPriceInput.value = projectBaseAmount;
        }
    });
});
</script>
{% endblock %}