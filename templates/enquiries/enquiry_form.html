{% extends "base.html" %}
{% block content %}
<style>
    .customer-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-light); }
    .tab-btn { padding: 0.75rem 1.5rem; border: 1px solid transparent; border-bottom: none; border-radius: 6px 6px 0 0; cursor: pointer; background: transparent; font-weight: 500; color: var(--text-secondary); }
    .tab-btn.active { background: var(--bg-secondary); border-color: var(--border-light); border-bottom-color: var(--bg-secondary); color: var(--primary-dark); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
</style>

<div style="max-width: 800px; margin: 0 auto;">
    <h1>Create Enquiry</h1>
    
    <form method="post">
        {% csrf_token %}

        <div class="card">
            <div class="card-header"><h3>Customer Details</h3></div>
            
            <div class="customer-tabs">
                <button type="button" class="tab-btn active" data-tab="existing">Existing Customer</button>
                <button type="button" class="tab-btn" data-tab="new">New Customer</button>
            </div>

            <!-- THIS IS THE SINGLE HIDDEN INPUT, PLACED OUTSIDE THE TABS -->
            <input type="hidden" name="form_type" value="existing" id="form_type_input">

            <!-- Existing Customer Tab -->
            <div id="tab-existing" class="tab-content active">
                <!-- The old hidden input is REMOVED from here -->
                {{ existing_customer_form.as_p }}
            </div>

            <!-- New Customer Tab -->
            <div id="tab-new" class="tab-content">
                {{ new_customer_form.as_p }}
            </div>
        </div>
        
        <div class="card">
            <div class="card-header"><h3>Project Details</h3></div>
            {{ enquiry_form.as_p }}
        </div>

        <div class="form-actions" style="text-align: right;">
            <button type="submit">Save Enquiry</button>
        </div>
    </form>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    const hiddenInput = document.getElementById('form_type_input');

    // --- THIS IS THE NEW FUNCTION ---
    function updateFormState(activeTabId) {
        tabContents.forEach(content => {
            const isActive = content.id === 'tab-' + activeTabId;
            content.classList.toggle('active', isActive);

            // Find all input, select, and textarea elements within the content
            const formElements = content.querySelectorAll('input, select, textarea');
            
            // If the tab is active, ENABLE its form elements.
            // If the tab is NOT active, DISABLE its form elements.
            formElements.forEach(element => {
                element.disabled = !isActive;
            });
        });
        
        // Always make sure our hidden form_type input is enabled
        if (hiddenInput) {
            hiddenInput.disabled = false;
        }
    }

    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');

            // Update button styles
            tabButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');

            // Update the hidden input value
            if (hiddenInput) {
                hiddenInput.value = tabId;
            }

            // Call our new function to handle enabling/disabling fields
            updateFormState(tabId);
        });
    });

    // --- RUN ON PAGE LOAD ---
    // Initialize the form state correctly when the page first loads
    updateFormState('existing');
});
</script>
{% endblock %}