{% extends "base.html" %}
{% block title %}Create Enquiry{% endblock %}
{% block content %}

<div class="form-page" style="max-width: 800px; margin: 0 auto;">
    <div class="page-header" style="flex-direction: column; align-items: flex-start; gap: 0.5rem;">
        <a href="{% url 'enquiries:enquiry_list' %}" class="text-muted" style="font-size: 0.875rem; text-decoration: none;">&larr; Back to Enquiries</a>
        <h1 class="page-title">Create Enquiry</h1>
    </div>

    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="existing" id="form_type_input">

        <div class="form-section card">
            <h3 class="form-section-title">Customer Details</h3>
            <div class="tabs">
                <button type="button" class="tab-btn active" data-tab="existing">Existing Customer</button>
                <button type="button" class="tab-btn" data-tab="new">New Customer</button>
            </div>
            <div id="tab-existing" class="tab-content active">
                {{ existing_customer_form.as_p }}
            </div>
            <div id="tab-new" class="tab-content">
                {{ new_customer_form.as_p }}
            </div>
        </div>

        <div class="form-section card">
            <h3 class="form-section-title">Project Details</h3>
            {{ enquiry_form.as_p }}
        </div>

        <div class="form-actions">
            <a href="{% url 'enquiries:enquiry_list' %}" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn">Save Enquiry</button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    const hiddenInput = document.getElementById('form_type_input');

    // --- THIS IS THE NEW FUNCTION ---
    function updateFormState(activeTabId) {
        tabContents.forEach(content => {
            const isActive = content.id === 'tab-' + activeTabId;
            content.classList.toggle('active', isActive);

            // Find all input, select, and textarea elements within the content
            const formElements = content.querySelectorAll('input, select, textarea');
            
            // If the tab is active, ENABLE its form elements.
            // If the tab is NOT active, DISABLE its form elements.
            formElements.forEach(element => {
                element.disabled = !isActive;
            });
        });
        
        // Always make sure our hidden form_type input is enabled
        if (hiddenInput) {
            hiddenInput.disabled = false;
        }
    }

    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');

            // Update button styles
            tabButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');

            // Update the hidden input value
            if (hiddenInput) {
                hiddenInput.value = tabId;
            }

            // Call our new function to handle enabling/disabling fields
            updateFormState(tabId);
        });
    });

    // --- RUN ON PAGE LOAD ---
    // Initialize the form state correctly when the page first loads
    updateFormState('existing');
});
</script>
{% endblock %}