{% extends "base.html" %}
{% load humanize %}
{% block title %}Accounts{% endblock %}
{% block content %}
<style>
    .accounts-page { font-size: 0.8125rem; }
    .accounts-page .page-header { margin-bottom: 0.75rem; }
    .accounts-page .page-title { font-size: 1.125rem; margin: 0; }
    .accounts-page .summary-row {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding: 0.5rem 0.75rem;
        background: #f8fafc;
        border: 1px solid var(--color-border);
        border-radius: 6px;
    }
    .accounts-page .summary-item { text-align: right; }
    .accounts-page .summary-item label { display: block; font-size: 0.7rem; color: var(--color-text-muted); text-transform: uppercase; margin-bottom: 0.15rem; }
    .accounts-page .summary-item .value { font-weight: 600; font-variant-numeric: tabular-nums; }
    .accounts-page .progress-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem; }
    .accounts-page .progress-box { padding: 0.5rem 0.75rem; background: #fff; border: 1px solid var(--color-border); border-radius: 6px; }
    .accounts-page .progress-box h4 { margin: 0 0 0.35rem 0; font-size: 0.75rem; font-weight: 600; color: var(--color-text-secondary); }
    .accounts-page .progress-bar { height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; }
    .accounts-page .progress-bar-inner { height: 100%; background: var(--color-accent); border-radius: 3px; }
    .accounts-page .progress-bar-inner.warning { background: var(--color-warning); }
    .accounts-page .progress-labels { font-size: 0.65rem; color: var(--color-text-muted); margin-top: 0.25rem; }
    .accounts-page .table-container { font-size: 0.8rem; }
    .accounts-page .data-table th { padding: 0.35rem 0.6rem; font-size: 0.7rem; }
    .accounts-page .data-table td { padding: 0.35rem 0.6rem; font-variant-numeric: tabular-nums; }
    .accounts-page .data-table .num { text-align: right; }
    .accounts-page .data-table .total-row { background: #f1f5f9; font-weight: 600; border-top: 2px solid var(--color-border); }
</style>

<div class="accounts-page">
<div class="page-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
    <h1 class="page-title">Accounts</h1>
    <div style="display: flex; gap: 0.5rem;">
        <a href="{% url 'accounts:incoming_payments' %}" class="btn btn-secondary">Incoming Payments</a>
        <a href="{% url 'invoices:invoice_create_select' %}" class="btn">Create Invoice</a>
        <a href="{% url 'accounts:export_project_summary' %}" class="btn btn-secondary">Export CSV</a>
    </div>
</div>

<!-- Summary row (accounting-style key figures) -->
<div class="summary-row">
    <div class="summary-item">
        <label>Project Value (ex. VAT)</label>
        <span class="value">AED {{ total_project_value|floatformat:2|intcomma }}</span>
    </div>
    <div class="summary-item">
        <label>Billed (inc. VAT)</label>
        <span class="value">AED {{ total_amount_invoiced|floatformat:2|intcomma }}</span>
    </div>
    <div class="summary-item">
        <label>Received</label>
        <span class="value">AED {{ total_amount_received|floatformat:2|intcomma }}</span>
    </div>
    <div class="summary-item">
        <label>Receivable</label>
        <span class="value">AED {{ total_pending|floatformat:2|intcomma }}</span>
    </div>
    <div class="summary-item">
        <label>Invoiced % / Paid %</label>
        <span class="value">{{ invoicing_percentage|floatformat:0 }}% / {{ payment_percentage|floatformat:0 }}%</span>
    </div>
</div>

<!-- Progress bars (compact) -->
<div class="progress-row">
    <div class="progress-box">
        <h4>Invoicing vs budget</h4>
        <div class="progress-bar"><div class="progress-bar-inner" style="width: {{ invoicing_percentage|floatformat:0 }}%;"></div></div>
        <div class="progress-labels">{{ invoicing_percentage|floatformat:0 }}% of budget billed</div>
    </div>
    <div class="progress-box">
        <h4>Collections vs billed</h4>
        <div class="progress-bar"><div class="progress-bar-inner warning" style="width: {{ payment_percentage|floatformat:0 }}%;"></div></div>
        <div class="progress-labels">{{ payment_percentage|floatformat:0 }}% of billed received</div>
    </div>
</div>

<!-- Project financial summary table -->
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>Project / Customer</th>
                <th class="num">Budget (ex. VAT)</th>
                <th class="num">Billed (inc. VAT)</th>
                <th class="num">Received</th>
                <th class="num">Receivable</th>
            </tr>
        </thead>
        <tbody>
            {% for project in projects %}
            <tr>
                <td>
                    <a href="{% url 'projects:project_detail' pk=project.pk %}">{{ project.title }}</a>
                    <br><small class="text-muted">{{ project.customer.name }}</small>
                </td>
                <td class="num">{{ project.subtotal|floatformat:2|intcomma }}</td>
                <td class="num">{{ project.total_invoiced_grand|floatformat:2|intcomma }}</td>
                <td class="num" style="color: var(--color-success);">{{ project.total_received|floatformat:2|intcomma }}</td>
                <td class="num" style="font-weight: 600;">{{ project.accounts_receivable|floatformat:2|intcomma }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="5" style="text-align: center; padding: 1rem;" class="text-muted">No projects.</td></tr>
            {% endfor %}
            <tr class="total-row">
                <td>Total</td>
                <td class="num">AED {{ total_project_value|floatformat:2|intcomma }}</td>
                <td class="num">AED {{ total_amount_invoiced|floatformat:2|intcomma }}</td>
                <td class="num">AED {{ total_amount_received|floatformat:2|intcomma }}</td>
                <td class="num">AED {{ total_pending|floatformat:2|intcomma }}</td>
            </tr>
        </tbody>
    </table>
</div>
</div>
{% endblock %}
