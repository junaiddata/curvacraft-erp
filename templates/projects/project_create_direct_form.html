<!-- templates/projects/project_create_direct_form.html -->
{% extends "base.html" %}
{% block content %}
<h1>Create Direct Project</h1>
<p>Use this form to create a project that does not have a prior enquiry or quotation.</p>

<form method="post">
    {% csrf_token %}
    
    <div class="card">
        <div class="card-header"><h3>Customer Details</h3></div>
        {{ customer_form.as_p }}
    </div>

    <div class="card">
        <div class="card-header"><h3>Project Details</h3></div>
        {{ project_form.as_p }}
    </div>

       <!-- THIS IS THE COMPLETED SECTION -->
        <div class="card">
            <div class="card-header"><h3>Project Scope & Budget</h3></div>
            
            {{ formset.management_form }}
            
            <table id="items-table" class="data-table">
                <thead>
                    <tr>
                        <th style="width: 50%;">Description</th>
                        <th>Quantity</th>
                        <th>Unit</th>
                        <th>Unit Price</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="item-form-list">
                    {% for item_form in formset.forms %}
                        <tr class="item-form-row">
                            {{ item_form.id }}
                            <td>{{ item_form.description }}</td>
                            <td>{{ item_form.quantity }}</td>
                            <td>{{ item_form.unit }}</td>
                            <td>{{ item_form.unit_price }}</td>
                            <td>
                                {{ item_form.DELETE }}
                                <button type="button" class="delete-btn">Delete</button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Hidden template for new rows -->
            <table style="display:none;">
                <tbody id="empty-form-template">
                    <tr class="item-form-row">
                        {{ formset.empty_form.id }}
                        <td>{{ formset.empty_form.description }}</td>
                        <td>{{ formset.empty_form.quantity }}</td>
                        <td>{{ formset.empty_form.unit }}</td>
                        <td>{{ formset.empty_form.unit_price }}</td>
                        <td>
                            {{ formset.empty_form.DELETE }}
                            <button type="button" class="delete-btn">Delete</button>
                        </td>
                    </tr>
                </tbody>
            </table>

            <button type="button" id="add-item-form" class="btn-secondary" style="margin-top: 1rem;">+ Add Item</button>
        </div>

        <div style="text-align: right; margin-top: 2rem;">
            <button type="submit">Create Project</button>
        </div>
    </form>
</div>



<!-- The add/delete item script from quotation_form.html goes here -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const formListBody = document.getElementById('item-form-list');
    const emptyFormTemplate = document.getElementById('empty-form-template').innerHTML;
    
    // The default prefix for an inline formset is the child model's name + '-set'.
    // In our case, it will be 'projectitem_set-TOTAL_FORMS' if no prefix is set in the view.
    // Let's make it robust by finding it.
    const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');
    
    // --- ADD ITEM LOGIC ---
    document.getElementById('add-item-form').addEventListener('click', function() {
        if (totalFormsInput) {
            let formNum = parseInt(totalFormsInput.value);
            let newFormHtml = emptyFormTemplate.replace(/__prefix__/g, formNum);
            formListBody.insertAdjacentHTML('beforeend', newFormHtml);
            totalFormsInput.value = formNum + 1;
        }
    });

    // --- DELETE ITEM LOGIC ---
    formListBody.addEventListener('click', function(event) {
        if (event.target && event.target.classList.contains('delete-btn')) {
            const row = event.target.closest('.item-form-row');
            
            if (row && !row.querySelector('input[name$="-id"][value]')) {
                if (confirm('Are you sure you want to remove this new item?')) {
                    row.remove();
                }
                return;
            }
            
            const deleteCheckbox = row.querySelector('input[type="checkbox"]');
            if (deleteCheckbox) {
                if (confirm('Are you sure you want to delete this item? This will be permanent upon saving.')) {
                    deleteCheckbox.checked = true;
                    row.classList.add('marked-for-deletion');
                }
            }
        }
    });
});
</script>
{% endblock %}