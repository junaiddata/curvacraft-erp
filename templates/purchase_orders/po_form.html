{% extends "base.html" %}
{% block title %}{{ action }} Purchase Order{% endblock %}
{% block content %}
<div class="form-page" style="max-width: 960px; margin: 0 auto;">
    <div class="page-header" style="flex-direction: column; align-items: flex-start; gap: 0.5rem;">
        {% if po %}
        <a href="{% url 'purchase_orders:po_detail' pk=po.pk %}" class="text-muted" style="font-size: 0.875rem; text-decoration: none;">&larr; Back to Purchase Order</a>
        {% else %}
        <a href="{% url 'purchase_orders:po_list' %}" class="text-muted" style="font-size: 0.875rem; text-decoration: none;">&larr; Back to Purchase Orders</a>
        {% endif %}
        <h1 class="page-title">{{ action }} Purchase Order</h1>
    </div>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-section">
            <h3 class="form-section-title">Header Details</h3>
            {{ form.as_p }}
        </div>

        <div class="form-section">
            <h3 class="form-section-title">Line Items</h3>
            <div class="table-container">
                <table id="items-table" class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 50%;">Description</th>
                            <th>Quantity</th>
                            <th>Unit</th>
                            <th>Unit Price</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="item-form-list">
                        {{ formset.management_form }}
                        {% for item_form in formset.forms %}
                        <tr class="item-form-row">
                            {{ item_form.id }}
                            <td>{{ item_form.description }}</td>
                            <td>{{ item_form.quantity }}</td>
                            <td>{{ item_form.unit }}</td>
                            <td>{{ item_form.unit_price }}</td>
                            <td>
                                {{ item_form.DELETE }}
                                <button type="button" class="delete-btn">Delete</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <table style="display:none;">
                <tbody id="empty-form-template">
                    <tr class="item-form-row">
                        {{ formset.empty_form.id }}
                        <td>{{ formset.empty_form.description }}</td>
                        <td>{{ formset.empty_form.quantity }}</td>
                        <td>{{ formset.empty_form.unit }}</td>
                        <td>{{ formset.empty_form.unit_price }}</td>
                        <td>
                            {{ formset.empty_form.DELETE }}
                            <button type="button" class="delete-btn">Delete</button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <button type="button" id="add-item-form" class="btn btn-secondary" style="margin-top: 1rem;">Add Item</button>
        </div>

        <div class="form-actions">
            {% if po %}
            <a href="{% url 'purchase_orders:po_detail' pk=po.pk %}" class="btn btn-secondary">Cancel</a>
            {% else %}
            <a href="{% url 'purchase_orders:po_list' %}" class="btn btn-secondary">Cancel</a>
            {% endif %}
            <button type="submit" class="btn">Save Purchase Order</button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const formListBody = document.getElementById('item-form-list');
    const emptyFormTemplate = document.getElementById('empty-form-template').innerHTML;
    const totalFormsInput = document.getElementById('id_items-TOTAL_FORMS');
    document.getElementById('add-item-form').addEventListener('click', function() {
        let formNum = parseInt(totalFormsInput.value);
        let newFormHtml = emptyFormTemplate.replace(/__prefix__/g, formNum);
        formListBody.insertAdjacentHTML('beforeend', newFormHtml);
        totalFormsInput.value = formNum + 1;
    });
    formListBody.addEventListener('click', function(event) {
        if (event.target && event.target.classList.contains('delete-btn')) {
            const row = event.target.closest('.item-form-row');
            if (!row.querySelector('input[name$="-id"]')) {
                if (confirm('Remove this new item?')) row.remove();
                return;
            }
            const deleteCheckbox = row.querySelector('input[type="checkbox"]');
            if (deleteCheckbox && confirm('Delete this item upon saving?')) {
                deleteCheckbox.checked = true;
                row.classList.add('marked-for-deletion');
            }
        }
    });
});
</script>
{% endblock %}
